---
title: "Stanford Community Engagement Hubs Map"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

<style>
.leaflet-container {
background: #f4f4f4;
}

.leaflet-shadow-pane {
visibility: hidden;
}

body {
padding:0 0 0 0;
background: #f4f4f4;
}

body hr {
margin: 0 0;
}

.section.sidebar {
  top: 0px;
  bottom: 10px;
  left: 0px;
  padding-top: 5px;
  padding-left: 10px;
  padding-right: 20px;
  background-color: #f4f4f4;
}

.chart-wrapper {
border: 0;
border-radius: 0;
margin-bottom: 0;
margin-right: 0;
}

.chart-shim {
position: absolute;
left: 10; 
top: 0; 
right: 0; 
bottom: 0;
}

.navbar{
visibility: hidden
}

.marker-cluster-small {
background-color: rgba(212,62,42,0.5);
}

.marker-cluster-small div {
background-color: rgba(212,62,42,1);
}

.marker-cluster-medium {
background-color: rgba(212,62,42,0.5);
}

.marker-cluster-medium div {
background-color: rgba(212,62,42,1);
}

.marker-cluster-large {
background-color: rgba(212,62,42,0.5);
}

.marker-cluster-large div {
background-color: rgba(212,62,42,1);
}

.btn:active {
background-color: #f0f0f0;
box-shadow: 0 0px #f0f0f0;
}

</style>

```{r global, include = FALSE}
library(flexdashboard)
library(readr)
library(dplyr)
library(purrr)
library(tidyr)
library(mapboxapi)
library(sf)
library(leaflet)
library(DT)
# library(hover)
# library(shinyjs)

data <- read_csv("https://raw.githubusercontent.com/citysystems/citysystems.github.io/master/oce/hubs_from_airtable.csv") %>% 
  st_as_sf(wkt = "geometry") %>% 
  mutate(geo = st_as_text(geometry))

unique_themes <- c("Arts & Humanities","Education","Environment and Sustainability","Equity or Socioeconomic Issues","Health","Identity & Human Rights","Law, Policy, & Justice","Recreation and Culture","Media and Technology","Global","Other")

unique_schools <- c("Dean of Research","Graduate School of Business","Graduate School of Education","Provost","School of Earth, Energy & Environmental Sciences","School of Engineering","School of Humanities & Sciences","School of Law","Stanford Medicine","Stanford Athletics","Vice President for the Arts","Vice Provost for Graduate Education","Vice Provost for Undergraduate Education") 

button_texts <- c("All Hubs",unique_schools,"")

urls <- c(
  "all_oce",
  "stanford_president",
  "stanford_business_s",
  "stanford_education_s",
  "stanford_flag_f",
  "stanford_eee_s",
  "stanford_engineering_s",
  "stanford_humanities_s",
  "stanford_law_s",
  "stanford_medicine_s",
  "stanfordlogo",
  "stanford_vpa_s",
  "stanford_vpge_s",
  "stanford_vpue_s",
  "placeholder_oce"
)

campus_hubs <- unique(data$`Campus Hubs`)

icons <- awesomeIcons(
  icon = "circle",
  iconColor = "#820000",
  markerColor = '#8C1515',
  library = 'fa'
)

icon_selected <- awesomeIcons(
  icon = "circle",
  iconColor = "#820000",
  markerColor = '#820000',
  library = 'fa'
)

button_style <- "display: inline-block;vertical-align:top; width: 144px;margin-left:3px; margin-right: 3px;"

text_home <- renderUI({
  HTML(paste(
    "<img src='https://raw.githubusercontent.com/citysystems/citysystems.github.io/master/images/oce.png' alt='Office of Community Engagement' style = 'width:70%; margin-left:-10px'>",
    h1(strong("Community Engagement Hubs")),
    sep = "<br>"
  ))
})

infotext <- renderUI({
  HTML(paste(
    "",
    "",
    "Managed by: <a href = https://community.stanford.edu/ target='_blank'>Stanford Office of Community Engagement</a>",
    "Contact us at: merryp@stanford.edu",
    "",
    "",
    "This interactive map represents Stanford’s engagement with the communities the university touches. It is intended to be a dynamic resource that illustrates Stanford’s many Community Engagement Hubs. OCE defines “Community Engagement Hubs” as the offices and units at Stanford that are able to:",
    "<ul><li>Point to one or more sustained partnerships with actionable work</li><li>Dedicate resources to sustain the partnership and engage faculty, staff, and students</li><li>Practice <a href = https://haas.stanford.edu/about/our-approach/principles-ethical-and-effective-service/ target='_blank'>ethical and effective service</a></li></ul>",
    "How to Navigate: ",
    "Click on the \"Impact Area\" dropdown menu to sort by engagement categories. Select the icons (in the icon view) or the school dropdown menu (in the list view) to sort based on Stanford schools and enter list view and enter list view. Click on the map markers or list items to display more information about a specific hub. To go back to the list view, click the \"Back to all\" button. To go back to the icon view, click anywhere on the map that's not a marker.",
    sep = "<br>"
  ))
})

back_filter <- renderUI({
  actionButton(
    inputId = "back",
    label = "Back to Filter",
    style="background: #3d464e;color: #f0f0f0;"
  )
})

back_all <- renderUI({
  actionButton(
    inputId = "back",
    label = "Back to All",
    style="background: #3d464e;color: #f0f0f0;"
  )
})

button_list <- list()
button_text_list <- list()

for(i in 1:15){
  
  button_list[[i]] <- div(
    actionButton(
      inputId = paste0("button",i),
      tags$img(src = paste0("https://raw.githubusercontent.com/citysystems/citysystems.github.io/master/icons/",urls[i],".png"),height = "50px"),
      style="background: transparent; border: none; outline: none;"
    ),
    style=button_style,
    align = "center"
  )
  
  button_text_list[[i]] <- div(
    HTML(paste0("<center><font size=3>",button_texts[i],"</font></center>")),
    style=button_style
  )
  
}

menu_list <- list()
i <- 1
x <- 1
while(i <= 15){
  
  menu_list[[x]] <- button_list[[i]]
  menu_list[[x+3]] <- button_text_list[[i]]
  
  i <- i + 1
  
  if(x%%3==0){
    x <- x + 4
  } else {
    x <- x + 1
  }
}

menu <- renderUI(menu_list)
```

Community Engagement Hub Map {.sidebar data-width=500}
-----------------------------------------------------------------------

<!-- <img src="https://raw.githubusercontent.com/citysystems/citysystems.github.io/master/images/oce.png" alt="Office of Community Engagement" style = "width:70%; margin-left:-10px"> -->

```{r}
uiOutput("sidebar2", style = "overflow-y: auto; width: 100% !important; height: 100% !important;")
# uiOutput("back_button")
# uiOutput("text")
# uiOutput("text_descriptive")
# uiOutput("theme_box")
# uiOutput("school_box")
# uiOutput("table_df")
# uiOutput("menu", style = "display:inline-block;width: 470px;")
# uiOutput("submit_button", style="display: inline-block;vertical-align:top; width: 450px;margin-top:30px;", align = "center")
# uiOutput("infotext")
```

```{r, context = "server"}
values <- reactiveValues(
  previous = "",
  school = NULL,
  school_change = NULL,
  name_list = "",
  radio_indicator = "icon",
  theme_select = NULL,
  school_filter = "no",
  theme_filter = "no"
)

output$sidebar2 <- renderUI({
  tagList(
    div(id = "placeholder_back_button"),
    uiOutput("text", style = "height: fit-content !important;"),
    div(id = "placeholder_text_descriptive"),
    div(id = "placeholder_theme_box"),
    uiOutput("theme_box", style = "height: fit-content !important;"),
    div(id = "placeholder_school_box"),
    div(id = "placeholder_table_df"),
    div(id = "placeholder_menu"),
    uiOutput("menu_box", style = "overflow-x:scroll !important; height: fit-content !important;"),
    div(id = "placeholder_submit_button"),
    uiOutput("submit_button", style="width: 450px; margin-top:30px; margin-bottom:10px; height: fit-content !important;", align = "center"),
    div(id = "placeholder_infotext"),
    uiOutput("infotext")
  )
})

output$text <- text_home

output$theme_box <- renderUI({
  selectizeInput(
    "theme_select_box",
    label = "Filter by Impact Area: ",
    choices = c(unique_themes),
    selected = NULL,
    multiple = TRUE,
    options = list(placeholder = "All Categories")
  )
})
  
output$menu_box <- renderUI({
  uiOutput("menu", style = "width: 470px !important;height: fit-content !important;")
})
output$menu <- menu

output$submit_button <- renderUI({
  actionButton(
    "submit",
    label ="Add or Modify a Hub", 
    onclick ="window.open('https://airtable.com/shr2a0fVHYMZc0OJI', '_blank')",
    width = "50%",
    style = "background: #3d464e;color: #f0f0f0;"
  )
})

output$infotext <- infotext
```

Row
-----------------------------------------------------------------------

### 

```{r}
leafletOutput("map")
```

```{r, context="server"}
output$map <- renderLeaflet({
  
  leaflet() %>% 
    addMapboxTiles(
      style_id = "streets-v11",
      username = "mapbox",
      access_token = "pk.eyJ1IjoiZGVyZWtvdXlhbmciLCJhIjoiY2s5Yno5bXByMDM1djNlcDhsMTFqM3VjcyJ9.bcf4iQucxDFqq-0a9bwmsQ",
      options = leaflet::tileOptions(minZoom = 9)
    ) %>% 
    addMapPane("selectable_hubs", 410) %>% 
    addMapPane("selection", 420) %>%
    addAwesomeMarkers(
      data = data,
      icon = icons,
      label = ~`Campus Hubs`,
      layerId = ~`Campus Hubs`,
      options = pathOptions(
        pane = "selectable_hubs"
      ),
      clusterOptions = markerClusterOptions(
        showCoverageOnHover = F,
        freezeAtZoom = "maxKeepSpiderfy"
      )
    ) %>% 
    setView(
      lng = -122.17014,
      lat = 37.42752,
      zoom = 15
    )
  
})
``` 

```{r, context="server"}
observeEvent(input$map_marker_click,{
  
  removeUI("#school_box")
  removeUI("#theme_box")
  removeUI("#infotext")
  removeUI("#menu_box")
  removeUI("#submit_button")
  removeUI("#table_df")
  
  marker <- input$map_marker_click
  
  selected_data2 <-
    data %>% 
    filter(`Campus Hubs` == marker$id)
  
  output$text <- renderUI({
    HTML(paste(
      paste0("<a href='",selected_data2$URL,"' target='_blank'>",h1(strong(selected_data2$`Campus Hubs`)),"</a>",collapse = "")
    ))      
  })
  
  removeUI("#text_descriptive")
  insertUI("#placeholder_text_descriptive","afterEnd",ui = uiOutput("text_descriptive"))
  output$text_descriptive <- renderUI({
    
    HTML(paste(
      "</br>",
      "</br>",
      if(!is.na(selected_data2$`Logo`)){tags$img(src = selected_data2$`Logo`,style = "max-width:400px; max-height:200px;height:auto;width:auto;")},
      if(!is.na(selected_data2$`Logo`)){paste0("</br>","</br>")},
      if(!is.na(selected_data2$Address)){paste0("<strong>Address:</strong> ",selected_data2$Address,"</br>")},
      if(!is.na(selected_data2$school_official)){paste0("<strong>Stanford Unit:</strong> ",selected_data2$school_official,"</br>")},
      if(!is.na(selected_data2$`Director Name (new)`)){paste0("<strong>Faculty Director Name:</strong> ",selected_data2$`Director Name (new)`,"</br>")},
      if(!is.na(selected_data2$`Other Point of Contact Name (new)`)){paste0("<strong>Points of Contact:</strong> ",selected_data2$`Other Point of Contact Name (new)`,"</br>")},
      "</br>",
      if(!is.na(selected_data2$Description)){paste0("<strong>Description:</strong> ",selected_data2$Description,"</br>")},
      if(!is.na(selected_data2$`Impact`)){paste0("<strong>Impact Area:</strong> ", selected_data2$`Impact`,"</br>")},
      "</br>",
      if(!is.na(selected_data2$`Featured Link`)){paste0("<strong><a href = '",selected_data2$`Featured Link`,"' target='_blank'>Featured Engagement</a></strong>: ",selected_data2$`Featured Text`)},
      "</br>",
      "</br>",
      tags$img(src = selected_data2$`Featured Photo`,width = "375px"),
      "</br>"
    ))
    
  })
  
  if(!is.null(values$school) | !is.null(values$theme_select)){
    
    removeUI("#back_button")
    insertUI("#placeholder_back_button", "afterEnd", ui = uiOutput("back_button", style = "height: fit-content !important;"))
    
    output$back_button <- back_filter
    
    if(!is.null(values$school)){values$school_filter <- "yes"}
    if(is.null(values$school) & !is.null(values$theme_select)){
      values$school_filter <- "no"
      values$theme_filter <-"yes"
    }
    if(!is.null(values$theme_select)){values$theme_filter <- "yes"}
    if(!is.null(values$school) & is.null(values$theme_select)){
      values$school_filter <- "yes"
      values$theme_filter <-"no"
    }
    
  }else{
    removeUI("#back_button")
    insertUI("#placeholder_back_button", "afterEnd", ui = uiOutput("back_button", style = "height: fit-content !important;"))
    output$back_button <- back_all
    
    values$school_filter <- "no"
    values$theme_filter <- "no"
  }
  
  test <- 
    selected_data2 %>% 
    extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE)
  
  leafletProxy("map") %>%
    clearMarkerClusters() %>% 
    clearMarkers() %>% 
    addAwesomeMarkers(
      data = selected_data2,
      icon = icons,
      label = ~`Campus Hubs`,
      layerId = ~`Campus Hubs`,
      options = pathOptions(
        pane = "selectable_hubs"
      )
    )%>% 
    flyTo(
      lng = test$lat, 
      lat = test$lon,
      zoom = 18
    ) 
  
})
```

```{r, context = "server"}
observeEvent(input$map_click, {
  
  values$theme_select <- NULL
  values$school <- NULL
  
  removeUI("#school_box")
  removeUI("#text_descriptive")
  removeUI("#table_df")
  removeUI("#back_button")
  
  output$text <- text_home
  
  removeUI("#theme_box")
  insertUI("#placeholder_theme_box","afterEnd",ui=uiOutput("theme_box", style = "height: fit-content !important;"))
  output$theme_box <- renderUI({
      selectizeInput(
        "theme_select_box",
        label = "Filter by Impact Area: ",
        choices = c(unique_themes),
        selected = values$theme_select,
        multiple = TRUE,
        options = list(placeholder = "All Categories")
      )
    })
  
  removeUI("#infotext")
  insertUI("#placeholder_infotext","afterEnd",ui=uiOutput("infotext", style = "height: fit-content !important;"))
  output$infotext <- infotext
  
  removeUI("#menu_box")
  insertUI("#placeholder_menu","afterEnd",ui=uiOutput("menu_box", style = "overflow-x: scroll !important; height: fit-content !important;"))
  
  removeUI("#submit_button")
  insertUI("#placeholder_submit_button","afterEnd",ui=uiOutput("submit_button", style="width: 450px; margin-top:30px; margin-bottom:10px; height: fit-content !important;", align = "center"))
  output$submit_button <- renderUI({
    actionButton(
      "submit",
      label ="Add or Modify a Hub", 
      onclick ="window.open('https://airtable.com/shr2a0fVHYMZc0OJI', '_blank')",
      width = "50%",
      style = "background: #3d464e;color: #f0f0f0;"
      
    )
  })
  
  leafletProxy("map") %>%
    clearMarkerClusters() %>% 
    clearMarkers() %>% 
    addAwesomeMarkers(
      data = data,
      icon = icons,
      label = ~`Campus Hubs`,
      layerId = ~`Campus Hubs`,
      options = pathOptions(
        pane = "selectable_hubs"
      ),
      clusterOptions = markerClusterOptions(
        showCoverageOnHover = F,
        freezeAtZoom = "maxKeepSpiderfy"
      )
    ) %>% 
    flyTo(
      lng = -122.17014,
      lat = 37.42752,
      zoom = 15
    )
  
  values$radio_indicator <- "icon"
 
})
```

```{r, context = "server"}
observeEvent(input$table_rows_selected,{
  
  removeUI("#school_box")
  removeUI("#theme_box")
  removeUI("#infotext")
  removeUI("#table_df")
  
  data_go <- data
  
  if(values$name_list != ""){
    rel_name <- values$name_list[input$table_rows_selected]
    
    test <- 
      data_go %>% 
      filter(`Campus Hubs` %in% rel_name) %>% 
      extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE)
    
    selected_data <- test
    
    selected_data2 <- 
      data_go %>% 
      filter(`Campus Hubs` %in% rel_name)
  }else{
    test <- 
      data_go[input$table_rows_selected,] %>% 
      extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE)
    
    selected_data <- test
    
    selected_data2 <- 
      data_go[input$table_rows_selected,]
  }
  
  leafletProxy("map") %>%
    clearMarkerClusters() %>% 
    clearMarkers() %>% 
    addAwesomeMarkers(
      data = selected_data2,
      icon = icons,
      label = ~`Campus Hubs`,
      layerId = ~`Campus Hubs`,
      options = pathOptions(
        pane = "selectable_hubs"
      )
    )%>% 
    flyTo(
      lng = test$lat, 
      lat = test$lon,
      zoom = 18
    ) 

  output$text <- renderUI({
    HTML(paste(
      paste0("<a href='",selected_data2$URL,"' target='_blank'>",h1(strong(selected_data2$`Campus Hubs`)),"</a>",collapse = "")
    ))      
  })

  removeUI("#text_descriptive")
  insertUI("#placeholder_text_descriptive","afterEnd",ui = uiOutput("text_descriptive"))
  output$text_descriptive <- renderUI({
    
    HTML(paste(
      "</br>",
      "</br>",
      if(!is.na(selected_data2$`Logo`)){tags$img(src = selected_data2$`Logo`,style = "max-width:400px; max-height:200px;height:auto;width:auto;")},
      if(!is.na(selected_data2$`Logo`)){paste0("</br>","</br>")},
      if(!is.na(selected_data2$Address)){paste0("<strong>Address:</strong> ",selected_data2$Address,"</br>")},
      if(!is.na(selected_data2$school_official)){paste0("<strong>Stanford Unit:</strong> ",selected_data2$school_official,"</br>")},
      if(!is.na(selected_data2$`Director Name (new)`)){paste0("<strong>Faculty Director Name:</strong> ",selected_data2$`Director Name (new)`,"</br>")},
      if(!is.na(selected_data2$`Other Point of Contact Name (new)`)){paste0("<strong>Points of Contact:</strong> ",selected_data2$`Other Point of Contact Name (new)`,"</br>")},
      "</br>",
      if(!is.na(selected_data2$Description)){paste0("<strong>Description:</strong> ",selected_data2$Description,"</br>")},
      if(!is.na(selected_data2$`Impact`)){paste0("<strong>Impact Area:</strong> ", selected_data2$`Impact`,"</br>")},
      "</br>",
      if(!is.na(selected_data2$`Featured Link`)){paste0("<strong><a href = '",selected_data2$`Featured Link`,"' target='_blank'>Featured Engagement</a></strong>: ",selected_data2$`Featured Text`)},
      "</br>",
      "</br>",
      tags$img(src = selected_data2$`Featured Photo`,width = "375px"),
      "</br>"
    ))
    
  })
  
  if(!is.null(values$school) | !is.null(values$theme_select)){
    
    removeUI("#back_button")
    insertUI("#placeholder_back_button", "afterEnd", ui = uiOutput("back_button", style = "height:fit-content !important;"))
    output$back_button <- back_filter
    
    if(!is.null(values$school)){values$school_filter <- "yes"}
    if(is.null(values$school) & !is.null(values$theme_select)){
      values$school_filter <- "no"
      values$theme_filter <-"yes"
    }
    if(!is.null(values$theme_select)){values$theme_filter <- "yes"}
    if(!is.null(values$school) & is.null(values$theme_select)){
      values$school_filter <- "yes"
      values$theme_filter <-"no"
    }
    
  }else{
    removeUI("#back_button")
    insertUI("#placeholder_back_button", "afterEnd", ui = uiOutput("back_button", style = "height:fit-content !important;"))
    output$back_button <- back_all
    
    values$school_filter <- "no"
    values$theme_filter <- "no"
  }
  
})
```

```{r, context = "server"}
observeEvent(input$back,{
  
  if(values$radio_indicator == "icon"){
    
    removeUI("#school_box")
    removeUI("#text_descriptive")
    removeUI("#table_df")
    removeUI("#back_button")
    
    output$text <- text_home
    
    removeUI("#info_text")
    insertUI("#placeholder_infotext", "afterEnd", ui = uiOutput("infotext", style = "height:fit-content !important;"))
    output$infotext <- infotext
    
    removeUI("#theme_box")
    insertUI("#placeholder_theme_box","afterEnd",ui=uiOutput("theme_box", style = "height:fit-content !important;"))
    output$theme_box <- renderUI({
      selectizeInput(
        "theme_select_box",
        label = "Filter by Impact Area: ",
        choices = c(unique_themes),
        selected = values$theme_select,
        multiple = TRUE,
        options = list(placeholder = "All Categories")
      )
    })
    
    removeUI("#menu_box")
    insertUI("#placeholder_menu","afterEnd",ui=uiOutput("menu_box", style = "overflow-x:scroll !important; height: fit-content !important;"))
    
    removeUI("#submit_button")
    insertUI("#placeholder_submit_button","afterEnd",ui=uiOutput("submit_button", style="width: 450px; margin-top:30px; margin-bottom:10px; height: fit-content !important;", align = "center"))
    output$submit_button <- renderUI({
      actionButton(
        "submit",
        label ="Add or Modify a Hub", 
        onclick ="window.open('https://airtable.com/shr2a0fVHYMZc0OJI', '_blank')",
        width = "50%",
        style = "background: #3d464e;color: #f0f0f0;"
        
      )
    })
    
    values$school <- NULL
    values$theme_select <- NULL
    
    leafletProxy("map") %>%
    clearMarkerClusters() %>% 
    clearMarkers() %>% 
    addAwesomeMarkers(
      data = data,
      icon = icons,
      label = ~`Campus Hubs`,
      layerId = ~`Campus Hubs`,
      options = pathOptions(
        pane = "selectable_hubs"
      ),
      clusterOptions = markerClusterOptions(
        showCoverageOnHover = F,
        freezeAtZoom = "maxKeepSpiderfy"
      )
    ) %>% 
    flyTo(
      lng = -122.17014,
      lat = 37.42752,
      zoom = 15
    )
    
  } else if(values$radio_indicator == "list"){
    
    if(values$school_filter == "no"){values$school <- NULL}
    if(values$theme_filter == "no"){values$theme_select <- NULL}
    
    output$text <- text_home
    
    removeUI("#infotext")
    removeUI("#text_descriptive")
    removeUI("#back_button")
    removeUI("#menu_box")
    removeUI("#submit_button")
    
    removeUI("#theme_box")
    insertUI("#placeholder_theme_box","afterEnd",ui=uiOutput("theme_box", style = "height:fit-content !important;"))
    output$theme_box <- renderUI({
      selectizeInput(
        "theme_select_box",
        label = "Filter by Impact Area: ",
        choices = c(unique_themes),
        selected = values$theme_select,
        multiple = TRUE,
        options = list(placeholder = "All Categories")
      )
    })
    
    removeUI("#school_box")
    insertUI("#placeholder_school_box","afterEnd",ui=uiOutput("school_box", style = "height:fit-content !important;"))
    output$school_box <- renderUI({
      selectizeInput(
        "school_select_box",
        label = "Filter by Stanford Unit: ",
        choices = c(unique_schools),
        selected = values$school,
        multiple = TRUE,
        options = list(placeholder = "All Schools")
      )
    })
    
    if(values$school_filter == "no" & values$theme_filter == "no"){
      
      display_data <- data %>%
        dplyr::select(`Campus Hubs`) %>%
        st_set_geometry(NULL) %>%
        filter(!duplicated(`Campus Hubs`))
      
      leafletProxy("map") %>%
        clearMarkerClusters() %>% 
        clearMarkers() %>% 
        addAwesomeMarkers(
          data = data,
          icon = icons,
          label = ~`Campus Hubs`,
          layerId = ~`Campus Hubs`,
          options = pathOptions(
            pane = "selectable_hubs"
          ),
          clusterOptions = markerClusterOptions(
            showCoverageOnHover = F,
            freezeAtZoom = "maxKeepSpiderfy"
          )
        ) %>% 
        flyTo(
          lng = -122.17014,
          lat = 37.42752,
          zoom = 15
        )
    } else {
      if(values$school_filter == "yes" & values$theme_filter == "no"){
        
        if(values$school == "All"){
          
          display_data <- data %>%
            dplyr::select(`Campus Hubs`) %>%
            st_set_geometry(NULL) %>%
            filter(!duplicated(`Campus Hubs`))
          
          map_data <- data
          
        } else {
          
          display_data <- data %>%
            filter(grepl(paste(values$school, collapse = "|"), school_official))  %>% 
            dplyr::select(`Campus Hubs`) %>%
            st_set_geometry(NULL) %>%
            filter(!duplicated(`Campus Hubs`))
          
          map_data <- 
            data %>%
            filter(grepl(paste(values$school, collapse = "|"), school_official)) 
          
        }
        
      } else if(values$school_filter == "yes" & values$theme_filter == "yes"){
        
        if(values$school == "All"){
          
          display_data <- data %>%
            filter(grepl(paste(values$theme_select, collapse = "|"),Impact)) %>% 
            dplyr::select(`Campus Hubs`) %>%
            st_set_geometry(NULL) %>%
            filter(!duplicated(`Campus Hubs`))
          
          map_data <- data %>% 
            filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
          
        } else {
          
          display_data <- data %>%
            filter(grepl(paste(values$school, collapse = "|"), school_official))  %>% 
            filter(grepl(paste(values$theme_select, collapse = "|"),Impact)) %>% 
            dplyr::select(`Campus Hubs`) %>%
            st_set_geometry(NULL) %>%
            filter(!duplicated(`Campus Hubs`))
          
          map_data <- 
            data %>%
            filter(grepl(paste(values$school, collapse = "|"), school_official))  %>% 
            filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
          
        }
        
      } else if(values$school_filter == "no" & values$theme_filter == "yes"){
        
        display_data <- data %>%
          filter(grepl(paste(values$theme_select, collapse = "|"),Impact)) %>% 
          dplyr::select(`Campus Hubs`) %>%
          st_set_geometry(NULL) %>%
          filter(!duplicated(`Campus Hubs`))
        
        map_data <- 
          data %>%
          filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
        
      }
      
      display_data <- map_data %>% 
        dplyr::select(`Campus Hubs`) %>%
        st_set_geometry(NULL) %>%
        filter(!duplicated(`Campus Hubs`))
      
      leafletProxy("map") %>%
        clearMarkerClusters() %>% 
        clearMarkers() %>% 
        addAwesomeMarkers(
          data = map_data,
          icon = icons,
          label = ~`Campus Hubs`,
          layerId = ~`Campus Hubs`,
          options = pathOptions(
            pane = "selectable_hubs"
          ),
          clusterOptions = markerClusterOptions(
            showCoverageOnHover = F,
            freezeAtZoom = "maxKeepSpiderfy"
          )
        ) %>% 
        flyTo(
          lng = -122.17014,
          lat = 37.42752,
          zoom = 15
        )
    }
    
    removeUI("#table_df")
    insertUI("#placeholder_table_df","afterEnd",ui=uiOutput("table_df", style = "height:fit-content !important;"))
    output$table_df <- renderUI({
      dataTableOutput('table')
    })
    
    output$table <- renderDataTable(
      display_data,
      options = list(
        pageLength = nrow(display_data),
        lengthChange = FALSE,
        bFilter=1,
        bInfo=0,
        bLengthChange=0,
        searchHighlight = TRUE,
        dom = 'ft'
      ),
      selection = 'single',
      rownames = FALSE
    )
    
  }
  
})
```

```{r, context = "server"}
observeEvent(values$school, {
  
  if(values$school == "All"){values$school <- NULL}
  
  removeUI("#infotext")
  removeUI("#menu_box")
  removeUI("#submit_button")
  
  values$radio_indicator <- "list"
  
  removeUI("#theme_box")
  insertUI("#placeholder_theme_box","afterEnd",ui=uiOutput("theme_box", style = "height:fit-content !important;"))
  output$theme_box <- renderUI({
    selectizeInput(
      "theme_select_box",
      label = "Filter by Impact Area: ",
      choices = c(unique_themes),
      selected = values$theme_select,
      multiple = TRUE,
      options = list(placeholder = "All Categories")
    )
  })
  
  removeUI("#school_box")
  insertUI("#placeholder_school_box","afterEnd",ui=uiOutput("school_box", style = "height:fit-content !important;"))
  output$school_box <- renderUI({
    selectizeInput(
      "school_select_box",
      label = "Filter by Stanford Unit: ",
      choices = c(unique_schools),
      selected = values$school,
      multiple = TRUE,
      options = list(placeholder = "All Schools")
    )
  })
  
  if(!is.null(values$school)){
    
    display_data <- data %>%
      filter(school_official %in% values$school) %>% 
      dplyr::select(`Campus Hubs`) %>%
      st_set_geometry(NULL) %>%
      filter(!duplicated(`Campus Hubs`))

  }else{
    
    display_data <- data %>%
      dplyr::select(`Campus Hubs`) %>%
      st_set_geometry(NULL) %>%
      filter(!duplicated(`Campus Hubs`))
  }
  
  removeUI("#table_df")
  insertUI("#placeholder_table_df","afterEnd",ui=uiOutput("table_df", style = "height:fit-content !important;"))
  output$table_df <- renderUI({
      dataTableOutput('table')
    })
    
  output$table <- renderDataTable(
    display_data,
    options = list(
      pageLength = nrow(display_data),
      lengthChange = FALSE,
      bFilter=1,
      bInfo=0,
      bLengthChange=0,
      searchHighlight = TRUE,
      dom = 'ft'
    ),
    selection = 'single',
    rownames = FALSE
  )
  
}, ignoreNULL = T)

observeEvent(input$button1, {
  values$school <- "All"
})

observeEvent(input$button2, {
  values$school <- "Dean of Research"
})

observeEvent(input$button3, {
  values$school <- "Graduate School of Business"
})

observeEvent(input$button4, {
  values$school <- "Graduate School of Education"
})

observeEvent(input$button5, {
  values$school <- "Provost"
})

observeEvent(input$button6, {
  values$school <- "School of Earth, Energy & Environmental Sciences"
})

observeEvent(input$button7, {
  values$school <- "School of Engineering"
})

observeEvent(input$button8, {
  values$school <- "School of Humanities & Sciences"
})

observeEvent(input$button9, {
  values$school <- "School of Law"
})

observeEvent(input$button10, {
  values$school <- "Stanford Medicine"
})

observeEvent(input$button11, {
  values$school <- "Stanford Athletics"
})

observeEvent(input$button12, {
  values$school <- "Vice President for the Arts"
})

observeEvent(input$button13, {
  values$school <- "Vice Provost for Graduate Education"
})

observeEvent(input$button14, {
  values$school <- "Vice Provost for Undergraduate Education"
})
```

```{r, context = "server"}
observeEvent(input$theme_select_box, ignoreNULL = F,{
  
  values$theme_select <- input$theme_select_box
  
  print(values$theme_select)
  print(values$school)

  if(!is.null(values$theme_select)){
    if(!is.null(values$school)){
      
      selectable_hubs <- 
        data %>% 
        filter(grepl(paste(values$school, collapse = "|"), school_official))  %>% 
        filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
      
    } else {
        
      selectable_hubs <- 
        data %>% 
        filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
      
    }
    
    if(nrow(selectable_hubs) > 0){
      values$name_list <- unique(selectable_hubs$`Campus Hubs`)
      
      leafletProxy('map') %>%
        clearMarkerClusters() %>% clearMarkers()
      
      leafletProxy("map") %>%
        addAwesomeMarkers(
          data = selectable_hubs,
          icon = icons,
          label = ~`Campus Hubs`,
          layerId = ~`Campus Hubs`,
          options = pathOptions(
            pane = "selectable_hubs"
          ),
          clusterOptions = markerClusterOptions(
            showCoverageOnHover = F,
            freezeAtZoom = "maxKeepSpiderfy"
          )
        )
    }else{
      leafletProxy("map") %>%
        clearMarkerClusters() %>% clearMarkers()
    }
  
  } else {

    if(!is.null(values$school)){
        
      selectable_hubs <-
        data %>% 
        filter(grepl(paste(values$school, collapse = "|"), school_official))
      
    }else{
      
      selectable_hubs <- data
      
    }
    
    values$name_list <- unique(selectable_hubs$`Campus Hubs`)
    
    leafletProxy('map') %>%
      clearMarkerClusters() %>% clearMarkers()
    
    leafletProxy("map") %>%
      addAwesomeMarkers(
        data = selectable_hubs,
        icon = icons,
        label = ~`Campus Hubs`,
        layerId = ~`Campus Hubs`,
        options = pathOptions(
          pane = "selectable_hubs"
        ),
        clusterOptions = markerClusterOptions(
          showCoverageOnHover = F,
          freezeAtZoom = "maxKeepSpiderfy"
        )
      )
    
  }
  
  if(values$radio_indicator == "list"){
    display_data <- 
      selectable_hubs %>% 
      dplyr::select(`Campus Hubs`) %>% 
      st_set_geometry(NULL)
    
    output$table <- renderDataTable(
      display_data,
      options = list(
        pageLength = nrow(display_data),
        lengthChange = FALSE,
        bFilter=1,
        bInfo=0,
        bLengthChange=0,
        searchHighlight = TRUE,
        dom = 'ft'
      ),
      selection = 'single',
      rownames = FALSE
    )
  }
  
})
```

```{r, context = "server"}
observeEvent(input$school_select_box,ignoreNULL = FALSE,{
  
  values$school <- input$school_select_box
  
  if(is.null(values$theme_select)){
    
    if(!is.null(values$school)){
      
      selectable_hubs <- 
        data %>% 
        filter(grepl(paste(values$school %>% map(~gsub("^Provost","^Provost|\"Provost",.)) %>% unlist(), collapse = "|"), school_official))
    }else{
      selectable_hubs <- 
        data
    }
  }else{
    if(!is.null(values$school)){
      selectable_hubs <- 
        data %>% 
        filter(grepl(paste(values$school %>% map(~gsub("^Provost","^Provost|\"Provost",.)) %>% unlist(), collapse = "|"), school_official))  %>%
        filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
    }else{
      selectable_hubs <- 
        data %>% 
        filter(grepl(paste(values$theme_select, collapse = "|"),Impact))
    }
  }
  
  if(nrow(selectable_hubs) > 0){
    values$name_list <- unique(selectable_hubs$`Campus Hubs`)
    
    leafletProxy('map') %>%
      clearMarkerClusters() %>% clearMarkers()
    
    leafletProxy("map") %>%
      addAwesomeMarkers(
        data = selectable_hubs,
        icon = icons,
        label = ~`Campus Hubs`,
        layerId = ~`Campus Hubs`,
        options = pathOptions(
          pane = "selectable_hubs"
        ),
        clusterOptions = markerClusterOptions(
          showCoverageOnHover = F,
          freezeAtZoom = "maxKeepSpiderfy"
        )
      )
    
  }else{
    leafletProxy("map") %>%
      clearMarkerClusters() %>% clearMarkers()
  }
  
  display_data <- 
    selectable_hubs %>% 
    dplyr::select(`Campus Hubs`) %>% 
    st_set_geometry(NULL)
  
  output$table <- renderDataTable(
    display_data,
    options = list(
      pageLength = nrow(display_data),
      lengthChange = FALSE,
      bFilter=1,
      bInfo=0,
      bLengthChange=0,
      searchHighlight = TRUE,
      dom = 'ft'
    ),
    selection = 'single',
    rownames = FALSE
  )
  
})
```